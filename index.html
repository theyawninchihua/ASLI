<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Auto Safety Library India</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
@font-face {
    font-family: 'CMU Sans Serif';
    src: url('fonts/cmunss.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
}

@font-face {
    font-family: 'CMU Serif';
    src: url('fonts/cmunrm.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
}

body {
    background: #000;
    color: #eee;
    font-family: 'CMU Sans Serif', system-ui, sans-serif;
    margin: 40px auto;
    max-width: 900px;
}

h1 { margin-bottom: 0.4em; }
.site-header { display:flex; align-items:center; gap:12px; margin-bottom:0.4em; }
.site-logo { width:64px; height:64px; object-fit:contain; }
@media (max-width:420px) { .site-logo { width:48px; height:48px; } }
.site-header h1 { margin:0; }

/* Feature category/subcategory styles used on car page */
.feature-category { margin-top:1.2em; color:#ccc; font-size:1.05em; }
.feature-hr { border:0; border-top:1px solid #444; margin:0.3em 0 0.8em 0; }

/* Subcategory boxed layout */
.sub-box { background:#1e1e1e; border:1px solid #333; border-radius:4px; padding:10px 12px; margin:12px 0; }
.sub-header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
.feature-subcategory { margin:0; color:#aaa; font-weight:normal; font-size:0.95em; }
.sub-score { color:#ccc; font-weight:bold; font-size:0.95em; }
.sub-box table { margin-top:8px; }

h2 { margin-top: 2.2em; color: #ccc; }
h3 { margin-top: 1.4em; color: #aaa; font-weight: normal; }

hr {
    border: 0;
    border-top: 1px solid #444;
    margin-bottom: 1.2em;
}

p {
    color: #bbb;
    max-width: 800px;
    line-height: 1.45;
}

.controls {
    margin: 2rem 0;
}

select {
    background: #333;
    color: white;
    padding: 0.5rem;
    border: 1px solid #555;
    border-radius: 0;
    font-family: inherit;
}

.item {
    display: flex;
    justify-content: flex-start;
    align-items: stretch; /* make thumb span full height */
    padding: 0; /* body will supply internal padding */
    margin: 12px 0;
    border: 1px solid #333;
}

.left {
    display: flex;
    flex-direction: column;
    flex: 1 1 auto;
    min-width: 0; /* allow text truncation if needed */
}

.item-body {
    display: flex;
    align-items: center;
    gap: 12px;
    background: #1e1e1e; /* grey region */
    padding: 14px; /* original padding moved here */
    flex: 1 1 auto;
    box-sizing: border-box;
}

.left .title {
    font-size: 1.05em;
    color: #fff;
}

.left .equipment {
    font-size: 0.95em;
    margin-bottom: 4px;
    color: #fff;
}

.left .variant {
    font-size: 0.8em;
    color: #ccc;
}

.item-thumb {
    /* fixed white region on the left that contains the centered thumbnail */
    width: 130px; /* fixed region width to allow padding around 110px thumbnail */
    padding: 8px; /* keep image away from the outer box border */
    background: #fff;
    box-sizing: border-box;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.item-thumb img {
    width: 110px; /* thumbnail width (keeps 110x60 ratio) */
    height: 60px;
    object-fit: cover;
    object-position: center;
    display: block;
}

.badge-box {
    width: 140px;
    height: 60px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-transform: uppercase;
    font-size: 0.75em;
    line-height: 1.1;
    color: black;
    font-family: Optima, 'CMU Serif', serif;
    margin-left: auto;
}

.badge-best {
    background: #00C000;
}

.badge-avoid {
    background: #C90000;
}

.badge-box .small {
    font-size: 0.7em;
}

.badge-box .main {
    font-size: 0.85em;
    font-weight: bold;
}
</style>
</head>

<body>

<div class="site-header">
    <a href="index.html" aria-label="Home"><img src="logos/logo_positive_square.png" alt="Auto Safety Library India logo" class="site-logo"></a>
    <h1>Auto Safety Library India</h1>
</div>

<p>
Here lies the safety specification of cars that were once sold in India.<br><br>
A vehicle might have had multiple specifications during a model year. There is no guarantee on the part of the year that the retrieved specification is from. When in doubt, always consult the manufacturer or official sources.
</p>


<div id="controls-container">
    <div class="controls" id="main-controls">
        Sort by:
        <select id="sortBy">
            <option value="Year">Year</option>
            <option value="Segment">Segment</option>
        </select>
    </div>
</div>
<div id="results"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>


<script>
const evaluationProtocol = {
    features: {
        frontal_airbag_driver: { weight: 10 },
        frontal_airbag_front_passenger: { weight: 10 },
        side_airbag_thorax_front: { weight: 7 },
        side_airbag_thorax_rear: { weight: 3 },
        side_airbag_curtain: { weight: 10 },
        three_point_belt_centre: { weight: 10 },
        head_restraint_outboard: { weight: 2 },
        head_restraint_outboard_adjustable: { weight: 1 },
        head_restraint_centre: { weight: 1 },
        head_restraint_centre_adjustable: { weight: 1 },
        isofix_lower_anchorages_outboard: { weight: 5 },
        abs: { weight: 10 },
        esc: { weight: 20 },
        sbr_driver: { weight: 4 },
        sbr_front_passenger: { weight: 3 },
        sbr_rear: { weight: 3 }
    }
};

const SHEET_CSV_URL =
'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5UQVUfEmi5jM0CGfExj6UE1K3WwcaD9iN1-lnIh0blsMle1PH0w6J_o1S3X_sZHjEKMRcUmc_m34K/pub?output=csv';

let cars = [];
let featureLabels = {}; // mapping internal feature id -> display name (from specsheet.json)
let specStructure = null; // full spec structure for categories/subcategories
// Load specsheet.json (optional; fallback to internal names)
const specPromise = fetch('specsheet.json')
    .then(r => r.ok ? r.json() : Promise.reject('specsheet not found'))
    .then(j => {
        specStructure = j;
        // spec file may have nested arrays/objects; extract all 'features' maps
        function extract(node) {
            if (!node) return;
            if (Array.isArray(node)) {
                node.forEach(extract);
                return;
            }
            if (typeof node === 'object') {
                if (node.features && typeof node.features === 'object') {
                    Object.assign(featureLabels, node.features);
                }
                // also check subcategories or nested arrays
                if (node.subcategories) extract(node.subcategories);
                Object.values(node).forEach(v => {
                    if (typeof v === 'object') extract(v);
                });
            }
        }
        extract(j);
    })
    .catch(() => {
        featureLabels = {};
        specStructure = null;
    });

// --- Canonical Car ID helpers ---
function canonicalCarId(car) {
    // Deterministic decoded ID: join fields with '__', normalize Unicode (NFC),
    // replace internal whitespace with underscores. Do NOT percent-encode here.
    const fields = [car.Year, car.Brand, car.Model, car["Equipment Level"], car.Variant];
    const parts = fields.map(f => {
        const s = (f === undefined || f === null) ? '' : String(f);
        // normalize to composed form so accents compare consistently
        const norm = s.normalize ? s.normalize('NFC') : s;
        return norm.trim().replace(/\s+/g, '_');
    });
    return parts.join('__');
}

function findCarById(id) {
    for (const c of cars) {
        if (canonicalCarId(c) === id) return c;
    }
    return null;
}

function getQueryParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
}

// --- Routing logic ---
function route() {
    const carId = getQueryParam('car');
    if (carId) {
        renderCarPage(carId);
    } else {
        renderMainPage();
    }
}

// --- CSV load and init ---
Papa.parse(SHEET_CSV_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: res => init(res.data)
});

function init(data) {
    cars = data;
    computeScores();
    // Wait for specsheet (labels) to be ready before routing/rendering,
    // but proceed even if specPromise fails.
    specPromise.finally(() => {
        route();
        // Attach sort handler only for main page
        document.getElementById("sortBy").onchange = route;
    });
}

function computeScores() {
    const groups = {};
    cars.forEach(c => {
        const key = `${c.Year}-${c.Segment}`;
        groups[key] = groups[key] || [];
        groups[key].push(c);
        let score = 0; 
        for (const f in evaluationProtocol.features) {
            if ((c[f] || "no").toLowerCase() === "yes") {
                score += evaluationProtocol.features[f].weight;
            }
        }
        c._score = score;
        c._id = canonicalCarId(c);
    });
    Object.values(groups).forEach(list => {
        const maxScore = Math.max(...list.map(c => c._score));
        list.forEach(c => {
            if (c._score <= 25) {
                c._badge = "Not Recommended";
            } else if (c._score >= maxScore - 10) {
                c._badge = "Best-in-Class";
            } else {
                c._badge = "";
            }
        });
    });
}

// --- Main page rendering ---
function renderMainPage() {
    document.getElementById('main-controls').style.display = '';
    const sortBy = document.getElementById("sortBy").value;
    const other = sortBy === "Year" ? "Segment" : "Year";
    const container = document.getElementById("results");
    container.innerHTML = "";
    const groups = {};
    cars.forEach(c => {
        groups[c[sortBy]] = groups[c[sortBy]] || {};
        groups[c[sortBy]][c[other]] = groups[c[sortBy]][c[other]] || [];
        groups[c[sortBy]][c[other]].push(c);
    });
    Object.keys(groups).sort().forEach(primary => {
        container.innerHTML += `<h2>${sortBy === 'Segment' ? (primary + ' segment') : primary}</h2><hr>`;
        Object.keys(groups[primary]).sort().forEach(secondary => {
            container.innerHTML += `<h3>${sortBy === 'Year' ? (secondary + ' segment') : secondary}</h3>`;
            groups[primary][secondary]
                .sort((a,b) => a._score - b._score)
                .forEach(c => {
                    // encodeURIComponent on the id when used in the URL
                    const urlId = encodeURIComponent(c._id);
                    container.innerHTML += `
                    <a href="index.html?car=${urlId}" style="text-decoration:none;color:inherit;">
                    <div class="item">
                        <div class="item-thumb">${c.Image ? '<img class="item-image" src="' + c.Image + '" alt="Car image">' : ''}</div>
                        <div class="item-body">
                            <div class="left">
                                <div class="title">${c.Year} ${c.Brand} ${c.Model}</div>
                                <div class="equipment">with ${c["Equipment Level"]} equipment</div>
                                <div class="variant">${c.Variant}</div>
                            </div>
                            ${renderBadge(c)}
                        </div>
                    </div>
                    </a>`;
                });
        });
    });
}

// --- Car page rendering ---
function renderCarPage(carId) {
    document.getElementById('main-controls').style.display = 'none';
    const container = document.getElementById("results");
    container.innerHTML = "";
    const car = findCarById(carId);
    if (!car) {
        container.innerHTML = `<div style='margin:2em 0;'>Result not found.<br><br><a href='index.html'>Back to list</a></div>`;
        return;
    }
    // Reuse the same .item box used on the main page as the page heading (no anchor)
    container.innerHTML += renderCarBox(car);
    // Score
    container.innerHTML += `<div style='font-size:1.1em;margin-bottom:1.2em;margin-top:0.6em;'>Total score: <b>${car._score}</b> max. 100</div>`;
    // Features table
    container.innerHTML += renderFeaturesTable(car);
    // Back link
    container.innerHTML += `<div style='margin-top:2em;'><a href='index.html'>&larr; Back to list</a></div>`;
}

function renderFeaturesTable(car) {
    // If we have a spec structure, render categories and subcategories
    if (specStructure) {
        let html = '';
        // specStructure could be nested arrays; normalize to array of category objects
        const cats = Array.isArray(specStructure[0]) ? specStructure[0] : specStructure;
        cats.forEach(cat => {
            const catName = cat.name || '';
            html += `<div class='feature-category'>${catName}</div><div class='feature-hr'></div>`;
            if (Array.isArray(cat.subcategories)) {
                cat.subcategories.forEach(sub => {
                    const subName = sub.name || '';
                    const feats = sub.features || {};
                    // compute subcategory scores
                    let subMax = 0;
                    let subScore = 0;
                    Object.keys(feats).forEach(fid => {
                        const w = (evaluationProtocol.features[fid] && evaluationProtocol.features[fid].weight) || 0;
                        subMax += w;
                        if ((car[fid]||'no').toLowerCase() === 'yes') subScore += w;
                    });
                    // render a sub-box containing header (name + score) and the table
                    html += `<div class='sub-box'>`;
                    html += `<div class='sub-header'><div class='feature-subcategory'>${subName}</div><div class='sub-score'>${subScore} max. ${subMax}</div></div>`;
                    html += `<div class='feature-hr'></div>`;
                    html += `<table style='background:#181818;border:1px solid #333;border-radius:4px;width:100%;max-width:700px;margin-bottom:0;margin-top:0.5em'>`;
                    html += `<tr><th style='text-align:left;padding:8px;color:#aaa;font-weight:normal;'>Feature</th><th style='text-align:left;padding:8px;color:#aaa;font-weight:normal;'>Present?</th></tr>`;
                    Object.keys(feats).forEach(fid => {
                        const label = feats[fid] || featureLabel(fid) || fid;
                        const val = (car[fid]||'no').toLowerCase() === 'yes' ? 'Yes' : 'No';
                        html += `<tr><td style='padding:8px;color:#ccc;'>${label}</td><td style='padding:8px;color:${val==='Yes'?'#0f0':'#c44'};'>${val}</td></tr>`;
                    });
                    html += `</table>`;
                    html += `</div>`; // .sub-box
                });
            }
        });
        return html;
    }
    // Fallback: previous single-table view
    let html = `<table style='background:#181818;border:1px solid #333;border-radius:4px;width:100%;max-width:500px;margin-bottom:1.5em;'>`;
    html += `<tr><th style='text-align:left;padding:8px;color:#aaa;font-weight:normal;'>Feature</th><th style='text-align:left;padding:8px;color:#aaa;font-weight:normal;'>Present?</th></tr>`;
    for (const f in evaluationProtocol.features) {
        const label = featureLabel(f);
        const val = (car[f]||'no').toLowerCase() === 'yes' ? 'Yes' : 'No';
        html += `<tr><td style='padding:8px;color:#ccc;'>${label}</td><td style='padding:8px;color:${val==='Yes'?'#0f0':'#c44'};'>${val}</td></tr>`;
    }
    html += `</table>`;
    return html;
}

function featureLabel(f) {
    // Prefer label from specsheet.json; fallback to internal name (underscores preserved)
    return featureLabels[f] || f;
}

// Render the same box used on the main page for a single car (no anchor)
function renderCarBox(c) {
    return `
    <div class="item" aria-hidden="true">
        <div class="item-thumb">${c.Image ? '<img class="item-image" src="' + c.Image + '" alt="Car image">' : ''}</div>
        <div class="item-body">
            <div class="left">
                <div class="title">${c.Year} ${c.Brand} ${c.Model}</div>
                <div class="equipment">with ${c["Equipment Level"]} equipment</div>
                <div class="variant">${c.Variant}</div>
            </div>
            ${renderBadge(c)}
        </div>
    </div>`;
}

function renderBadge(c) {
    if (!c._badge) return "";
    if (c._badge === "Not Recommended") {
        return `<div class="badge-box badge-avoid">
            <div class="main">Not<br>Recommended</div>
        </div>`;
    }
    return `<div class="badge-box badge-best">
        <div class="small">${c.Segment}-segment</div>
        <div class="main">Best-in-Class</div>
        <div class="small">${c.Year}</div>
    </div>`;
}

// --- Listen to browser navigation (back/forward) ---
window.addEventListener('popstate', () => {
    if (cars.length) route();
});
</script>

</body>
</html>